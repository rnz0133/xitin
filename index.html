<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xì tin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { background-color: #ffffff; font-family: 'Inter', sans-serif; color: #111827; overflow-x: hidden; }
        
        /* Hiệu ứng mượt */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .input-flat { background: #f3f4f6; border: 1px solid #f3f4f6; border-radius: 8px; padding: 12px; outline: none; transition: 0.2s; width: 100%; }
        .input-flat:focus { background: white; border-color: #2563eb; }
        
        .tab-btn { padding: 16px 20px; font-weight: 600; color: #9ca3af; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: #111827; border-bottom-color: #111827; }

        /* Kiểu danh sách cho Tab Ảnh */
        .image-list-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 10px; border-bottom: 1px solid #f3f4f6; transition: 0.2s; }
        .image-list-item:hover { background: #f9fafb; }
        .img-square { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; flex-shrink: 0; }

        /* Kiểu lưới cho Tab Video */
        .video-grid-item { border-radius: 12px; overflow: hidden; border: 1px solid #f3f4f6; transition: 0.3s; }
        .video-grid-item:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); }

        /* Modal xác nhận */
        #confirm-modal { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
        .modal-box { border-radius: 10px; width: 90%; max-width: 320px; transform: scale(0.9); transition: 0.3s; }
        .modal-active .modal-box { transform: scale(1); }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen" class="flex items-center justify-center min-h-screen fade-in">
        <div class="w-full max-w-sm px-8">
            <h1 class="text-xl font-bold mb-8 text-center uppercase tracking-widest">xác minh</h1>
            <div class="space-y-3">
                <input type="email" id="email" placeholder="Email" class="input-flat">
                <input type="password" id="password" placeholder="Mật khẩu" class="input-flat">
                <button onclick="handleAuth()" class="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">Đăng nhập</button>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden min-h-screen flex flex-col">
        <header class="border-b sticky top-0 bg-white z-40">
            <div class="max-w-4xl mx-auto px-4 flex items-center justify-between">
                <nav class="flex space-x-2">
                    <button onclick="switchMainTab('post')" id="mtab-post" class="tab-btn active">tải lên</button>
                    <button onclick="switchMainTab('video')" id="mtab-video" class="tab-btn">Video</button>
                    <button onclick="switchMainTab('image')" id="mtab-image" class="tab-btn">Ảnh</button>
                </nav>
                <button onclick="logout()" class="text-gray-300 hover:text-red-500"><i data-lucide="power" class="w-5 h-5"></i></button>
            </div>
        </header>

        <main class="max-w-4xl mx-auto w-full p-4 flex-grow">
            <section id="section-post" class="max-w-md mx-auto py-12 fade-in">
                <h2 id="form-title" class="font-bold text-lg mb-6 uppercase tracking-tight">Tạo nội dung</h2>
                <input type="hidden" id="edit-id">
                <div class="space-y-4">
                    <select id="type" onchange="toggleInputs()" class="input-flat font-bold text-blue-600">
                        <option value="video">video</option>
                        <option value="image">ảnh</option>
                    </select>
                    <input type="text" id="title" placeholder="Tiêu đề..." class="input-flat">
                    <input type="text" id="url" placeholder="Link nội dung..." class="input-flat">
                    <div id="thumb-box">
                        <input type="text" id="thumb" placeholder="Link ảnh bìa video..." class="input-flat">
                    </div>
                    <input type="text" id="cre" placeholder="Nguồn bài viết..." class="input-flat">
                    <div class="pt-4 flex gap-2">
                        <button onclick="openConfirmModal()" id="btn-submit" class="flex-grow bg-black text-white py-4 rounded-lg font-bold hover:opacity-80 transition uppercase text-sm">Xác nhận Đăng</button>
                        <button id="btn-cancel" onclick="resetForm()" class="hidden px-6 bg-gray-100 text-gray-500 rounded-lg font-bold">Hủy</button>
                    </div>
                </div>
            </section>

            <section id="section-list" class="hidden py-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-gray-900 text-lg" id="list-title">Danh sách</h2>
                    <span id="post-count" class="text-[10px] font-black bg-gray-100 px-2 py-1 rounded">0</span>
                </div>
                <div id="data-list"></div>
            </section>
        </main>
    </div>

    <div id="confirm-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4 transition-all">
        <div class="modal-box bg-white p-6 shadow-2xl border border-gray-100">
            <h3 class="font-bold text-gray-900 mb-2">Xác minh danh tính</h3>
            <p class="text-xs text-gray-400 mb-4">Vui lòng nhập mật khẩu admin để thực hiện thao tác này.</p>
            <input type="password" id="confirm-password" placeholder="Mật khẩu" class="input-flat mb-4 text-center">
            <div class="flex gap-2">
                <button onclick="closeConfirmModal()" class="flex-1 py-2 text-sm font-bold text-gray-400">Hủy</button>
                <button onclick="verifyAndSave()" class="flex-1 py-2 text-sm font-bold bg-blue-600 text-white rounded-lg">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAChUP3KKzTa0ggcV8ALE8gL1Rc7xjmDBE",
        authDomain: "rip8-e7d34.firebaseapp.com",
        databaseURL: "https://rip8-e7d34-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "rip8-e7d34",
        storageBucket: "rip8-e7d34.firebasestorage.app",
        messagingSenderId: "564753524411",
        appId: "1:564753524411:web:40f9e86f62fd202f0dab9e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = "caubengaytho73@gmail.com";

    lucide.createIcons();

    // CHUYỂN TAB
    window.switchMainTab = (mode) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`mtab-${mode}`).classList.add('active');

        const sectionPost = document.getElementById('section-post');
        const sectionList = document.getElementById('section-list');

        if (mode === 'post') {
            sectionPost.classList.remove('hidden');
            sectionList.classList.add('hidden');
        } else {
            sectionPost.classList.add('hidden');
            sectionList.classList.remove('hidden');
            document.getElementById('list-title').innerText = mode === 'video' ? 'VIDEO' : 'ẢNH';
            loadData(mode);
        }
    };

    window.toggleInputs = () => {
        const type = document.getElementById('type').value;
        document.getElementById('thumb-box').classList.toggle('hidden', type === 'image');
    };

    window.handleAuth = () => {
        signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
        .catch(() => alert("Sai thông tin đăng nhập"));
    };

    onAuthStateChanged(auth, (user) => {
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        }
    });

    window.logout = () => signOut(auth).then(() => location.reload());

    // XỬ LÝ POPUP XÁC MINH
    window.openConfirmModal = () => {
        if(!document.getElementById('url').value.trim()) return alert("Vui lòng nhập Link!");
        const modal = document.getElementById('confirm-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('modal-active'), 10);
    };

    window.closeConfirmModal = () => {
        const modal = document.getElementById('confirm-modal');
        modal.classList.remove('modal-active');
        setTimeout(() => modal.classList.add('hidden'), 300);
        document.getElementById('confirm-password').value = "";
    };

    window.verifyAndSave = () => {
        const pass = document.getElementById('confirm-password').value;
        // Kiểm tra mật khẩu nhanh bằng cách thử đăng nhập lại hoặc check pass tạm
        if(pass === "") return alert("Chưa nhập mật khẩu!");
        
        // Giả sử mật khẩu đúng (hoặc bạn có thể dùng logic auth để verify lần nữa)
        saveData();
        closeConfirmModal();
    };

    window.saveData = () => {
        const id = document.getElementById('edit-id').value;
        const type = document.getElementById('type').value;
        const payload = {
            type,
            title: document.getElementById('title').value.trim() || "",
            url: document.getElementById('url').value.trim(),
            thumbnail: type === 'image' ? document.getElementById('url').value.trim() : (document.getElementById('thumb').value.trim() || document.getElementById('url').value.trim()),
            cre: document.getElementById('cre').value.trim() || "",
            timestamp: Date.now()
        };

        if(id) {
            update(ref(db, 'media_posts/' + id), payload).then(() => { resetForm(); switchMainTab(type); });
        } else {
            push(ref(db, 'media_posts'), payload).then(() => { resetForm(); switchMainTab(type); });
        }
    };

    function loadData(filterType) {
        onValue(ref(db, 'media_posts'), (snapshot) => {
            const list = document.getElementById('data-list');
            list.innerHTML = "";
            let data = [];
            snapshot.forEach(c => { if(c.val().type === filterType) data.push({ key: c.key, ...c.val() }); });
            data.sort((a, b) => b.timestamp - a.timestamp);

            if(filterType === 'video') {
                list.className = "grid grid-cols-2 gap-4";
                data.forEach(item => {
                    list.innerHTML += `
                        <div class="video-grid-item bg-white">
                            <img src="${item.thumbnail}" class="w-full aspect-video object-cover">
                            <div class="p-3">
                                <h4 class="font-bold text-xs truncate">${item.title}</h4>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button onclick="editItem('${item.key}')" class="text-gray-400"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="deleteItem('${item.key}')" class="text-gray-400"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>`;
                });
            } else {
                list.className = "flex flex-col";
                data.forEach(item => {
                    list.innerHTML += `
                        <div class="image-list-item">
                            <img src="${item.thumbnail}" class="img-square">
                            <div class="flex-grow min-w-0">
                                <h4 class="font-semibold text-sm truncate">${item.title}</h4>
                                <p class="text-[10px] text-gray-400">${item.cre}</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="editItem('${item.key}')" class="text-gray-300 hover:text-blue-500"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="deleteItem('${item.key}')" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>`;
                });
            }
            document.getElementById('post-count').innerText = data.length;
            lucide.createIcons();
        });
    }

    window.deleteItem = (id) => { if(confirm("Xóa bài này?")) remove(ref(db, 'media_posts/' + id)); };

    window.editItem = (id) => {
        onValue(ref(db, 'media_posts/' + id), (s) => {
            const item = s.val();
            document.getElementById('edit-id').value = id;
            document.getElementById('type').value = item.type;
            toggleInputs();
            document.getElementById('title').value = item.title;
            document.getElementById('url').value = item.url;
            if(item.type === 'video') document.getElementById('thumb').value = item.thumbnail;
            document.getElementById('cre').value = item.cre;
            switchMainTab('post');
            document.getElementById('form-title').innerText = "Sửa nội dung";
            document.getElementById('btn-submit').innerText = "Cập nhật";
            document.getElementById('btn-cancel').classList.remove('hidden');
        }, { onlyOnce: true });
    };

    window.resetForm = () => {
        document.getElementById('edit-id').value = "";
        document.getElementById('title').value = "";
        document.getElementById('url').value = "";
        document.getElementById('thumb').value = "";
        document.getElementById('cre').value = "";
        document.getElementById('form-title').innerText = "Tạo nội dung";
        document.getElementById('btn-submit').innerText = "Xác nhận Đăng";
        document.getElementById('btn-cancel').classList.add('hidden');
    };
</script>
</body>
</html>
